<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Journal</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#9E7E67" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Trading Journal" />
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- Modern Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    <?!= include('styles'); ?>
  </style>
  <script>
    window.WEB_APP_URL = <?!= JSON.stringify(webAppUrl) ?>;
  </script>
</head>
<body>
  <header class="topbar">
    <div class="header-content">
      <h1 class="app-title">Trading Journal</h1>
      <nav class="nav">
        <button class="nav-link" data-route="#dashboard">Dashboard</button>
        <button class="nav-link" data-route="#new">New Trade</button>
        <button class="nav-link" data-route="#trades">Trade List</button>
        <button class="nav-link" data-route="#settings">Settings</button>
      </nav>
    </div>
  </header>

  <main id="app">
    <section id="view-dashboard" class="view hidden"></section>
    <section id="view-new" class="view hidden"></section>
    <section id="view-trades" class="view hidden"></section>
    <section id="view-settings" class="view hidden"></section>
  </main>

  <?!= include('partials'); ?>

  <div id="toast" class="toast hidden"></div>

    <script>
    // Simple diagnostic script
    console.log('Trading Journal starting...');
    console.log('WEB_APP_URL:', window.WEB_APP_URL);

    // Test if files are loading
    setTimeout(() => {
      console.log('Checking if templates exist...');
      const dashboardTpl = document.getElementById('tpl-dashboard');
      const newTpl = document.getElementById('tpl-new');
      console.log('Dashboard template:', dashboardTpl ? 'Found' : 'Missing');
      console.log('New trade template:', newTpl ? 'Found' : 'Missing');

      // Test API
      if (window.WEB_APP_URL) {
        console.log('Testing API...');
        fetch(window.WEB_APP_URL + '?path=/api/settings')
          .then(r => r.json())
          .then(data => console.log('API test result:', data))
          .catch(err => console.error('API test failed:', err));
      }
    }, 1000);

    // Fallback navigation if main script fails
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, setting up fallback navigation...');

      // Only setup fallback if main app script hasn't loaded
      setTimeout(() => {
        if (typeof window.navigate === 'undefined') {
          console.log('Main app not loaded, using fallback navigation');

          // Add click handlers for navigation buttons
          document.querySelectorAll('.nav-link').forEach(button => {
            button.addEventListener('click', (e) => {
              e.preventDefault();
              const route = e.target.dataset.route;
              console.log('Fallback navigation clicked:', route);

              // Update URL
              window.location.hash = route;

              // Update active state
              document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
              e.target.classList.add('active');

              // Basic content switching
              document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
              const viewId = 'view-' + route.substring(1);
              const targetView = document.getElementById(viewId);
              if (targetView) {
                targetView.classList.remove('hidden');
                // Load basic content from templates
                const templateId = 'tpl-' + route.substring(1);
                const template = document.getElementById(templateId);
                if (template) {
                  targetView.innerHTML = template.innerHTML;
                }
              }
            });
          });
        } else {
          console.log('Main app loaded, skipping fallback navigation');
        }
      }, 2000); // Wait 2 seconds for main app to load

      // Load dashboard by default
      setTimeout(() => {
        if (!window.location.hash) {
          window.location.hash = '#dashboard';
        }
      }, 100);
    });
  </script>

  <script>
    <?!= include('app'); ?>
  </script>
</body>
</html>
