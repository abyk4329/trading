<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Journal</title>

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#9E7E67" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Trading Journal" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="msapplication-TileColor" content="#9E7E67" />
  <meta name="msapplication-config" content="/browserconfig.xml" />

  <!-- PWA Links -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='64' fill='%239E7E67'/><text x='256' y='280' font-family='Arial, sans-serif' font-size='200' font-weight='bold' text-anchor='middle' fill='%23EAEAE7'>ðŸ“Š</text></svg>" />

  <link rel="stylesheet" href="styles.css" />
  <script>
    // If served via Apps Script, Code.gs can inject window.WEB_APP_URL; otherwise leave empty
    window.WEB_APP_URL = window.WEB_APP_URL || '';

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>
</head>
<body>
  <header class="topbar">
    <div class="header-content">
      <h1 class="app-title">Trading Journal</h1>
      <nav class="nav">
        <a href="#dashboard" class="nav-link">Dashboard</a>
        <a href="#new" class="nav-link">New Trade</a>
        <a href="#trades" class="nav-link">Trade List</a>
        <a href="#settings" class="nav-link">Settings</a>
      </nav>
    </div>
  </header>

  <main id="app">
    <section id="view-dashboard" class="view hidden"></section>
    <section id="view-new" class="view hidden"></section>
    <section id="view-trades" class="view hidden"></section>
    <section id="view-settings" class="view hidden"></section>
  </main>

  <template id="tpl-dashboard">
    <div class="cards">
      <div class="card"><div class="label">Current Balance</div><div class="value" id="cur-balance">â€”</div></div>
      <div class="card"><div class="label">Daily Target</div><div class="value" id="daily-target">â€”</div></div>
      <div class="card"><div class="label">Max Daily Loss</div><div class="value" id="daily-max-loss">â€”</div></div>
    </div>
    <div class="progress">
      <div class="progress-label">Today's Target Progress</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
      <div class="progress-stats"><span id="today-pnl">0</span> / <span id="today-target">0</span></div>
    </div>
    <div class="stats-grid">
      <div class="stat"><div class="label">Daily Hit Rate</div><div class="value" id="hit-rate-day">â€”</div></div>
      <div class="stat"><div class="label">Weekly Hit Rate</div><div class="value" id="hit-rate-week">â€”</div></div>
      <div class="stat"><div class="label">Avg R:R</div><div class="value" id="avg-rr">â€”</div></div>
      <div class="stat"><div class="label">Daily P&L</div><div class="value" id="sum-day">â€”</div></div>
      <div class="stat"><div class="label">Weekly P&L</div><div class="value" id="sum-week">â€”</div></div>
    </div>
  </template>

  <template id="tpl-new">
    <form id="new-trade-form" class="form">
      <div class="form-grid">
        <label>Date<input type="date" name="date" required></label>
        <label>Time<input type="time" name="time" required></label>
        <label>Symbol<select name="symbol" id="symbol-select" required>
          <option value="">Select Symbol</option>
          <option value="GOLD">Gold (XAU/USD)</option>
          <option value="MINI_NASDAQ">Mini Nasdaq (MNQ)</option>
          <option value="MICRO_NASDAQ">Micro Nasdaq (NQ)</option>
          <option value="NASDAQ_100">Nasdaq 100 (NDX)</option>
        </select></label>
        <label>Direction<select name="direction" required>
          <option value="Long">Long</option>
          <option value="Short">Short</option>
        </select></label>
        <label>Entry Price<input type="number" step="0.01" name="entry" id="entry" placeholder="0.00"></label>
        <label>Stop Loss<input type="number" step="0.01" name="stop" id="stop" placeholder="0.00"></label>
        <label title="TP will be calculated symmetrically to Entry/Stop if checked">
          Take Profit
          <input type="number" step="0.01" name="take_profit" id="take_profit" placeholder="0.00">
        </label>
        <label>Quantity<input type="number" step="1" name="qty" id="qty" placeholder="1"></label>
        <label>Commission ($)<input type="number" step="0.01" name="commission" id="commission" value="0" placeholder="0.00"></label>
        <label>Additional Fees ($)<input type="number" step="0.01" name="fees" id="fees" value="0" placeholder="0.00"></label>
        <label>Notes<textarea name="notes" placeholder="Trade notes..."></textarea></label>
      </div>
      <div class="side-info">
        <div>Balance: <span id="si-balance">â€”</span></div>
        <div>TP%: <span id="si-tp">â€”</span> | SL%: <span id="si-sl">â€”</span></div>
        <div>Risk ($): <span id="si-risk">â€”</span></div>
        <div>Target ($): <span id="si-tp-amount">â€”</span> | Stop ($): <span id="si-sl-amount">â€”</span></div>
        <div>R:R: <span id="si-rr">â€”</span></div>
        <label class="inline"><input type="checkbox" id="auto-tp" checked> Auto-calculate TP</label>
      </div>
      <div class="actions">
        <button type="submit" data-status="Planned">Save as Planned</button>
        <button type="submit" data-status="Executed" class="secondary">Mark as Executed</button>
      </div>
    </form>
  </template>

  <template id="tpl-trades">
    <div class="filters">
      <input type="date" id="flt-start" placeholder="Start Date" />
      <input type="date" id="flt-end" placeholder="End Date" />
      <select id="flt-symbol">
        <option value="">All Symbols</option>
        <option value="GOLD">Gold (XAU/USD)</option>
        <option value="MINI_NASDAQ">Mini Nasdaq (MNQ)</option>
        <option value="MICRO_NASDAQ">Micro Nasdaq (NQ)</option>
        <option value="NASDAQ_100">Nasdaq 100 (NDX)</option>
      </select>
      <select id="flt-status" multiple>
        <option>Planned</option>
        <option>Executed</option>
        <option>TP</option>
        <option>SL</option>
        <option>BE</option>
        <option>Partial</option>
        <option>Cancelled</option>
      </select>
      <button id="apply-filter">Filter</button>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th><th>Date</th><th>Time</th><th>Symbol</th><th>Direction</th><th>Entry</th><th>Stop</th><th>TP</th><th>Qty</th><th>R:R</th><th>Status</th><th>P&L ($)</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="trades-body"></tbody>
    </table>
  </template>

  <template id="tpl-settings">
    <form id="settings-form" class="form">
      <div class="form-grid">
        <label>Starting Balance ($)<input type="number" step="0.01" name="starting_balance" required placeholder="10000.00"></label>
        <label>Daily Target ($)<input type="number" step="0.01" name="daily_target" required placeholder="100.00"></label>
        <label>Max Daily Loss ($)<input type="number" step="0.01" name="daily_max_loss" required placeholder="50.00"></label>
        <label>TP %<input type="number" step="0.01" name="tp_pct" required placeholder="2.00"></label>
        <label>SL %<input type="number" step="0.01" name="sl_pct" required placeholder="1.00"></label>
      </div>
      <h3>Instruments</h3>
      <table class="table">
        <thead><tr><th>Symbol</th><th>Tick Size</th><th>Tick Value ($)</th><th>Contract Size</th><th></th></tr></thead>
        <tbody id="inst-body"></tbody>
      </table>
      <button type="button" id="add-inst">Add Instrument</button>
      <div class="actions">
        <button type="submit">Save</button>
      </div>
    </form>
  </template>

  <div id="toast" class="toast hidden"></div>
  <script src="app.js"></script>
</body>
</html>
